{% extends 'base.html' %}

{% block content %}

<div class="headline">
  <a class="btn" href="{% url 'topics_index' %}">Back to Topics</a>
  <h1>{{ topic.title }}</h1>
  <div class="headline-links">
  {% if  user.account.user_id == topic.user_id %}  
    <a class="btn" href="{% url 'topic_update' topic.id %}">Edit</a>
    <a class="btn" href="{% url 'topic_delete' topic.id %}">Delete</a>
  {% endif %}
  </div>
</div>
<div>
  {% with topic.topicphoto_set.all as photos %}
  {% for photo in photos %}
  {% if photo == photos.first %}
  <img src="{{ photo.url }}" alt="{{ photo.url }}" class="responsive-img card-panel">
  {% endif %}
  {% empty %}
  <div>No topic photo</div>
  {% endfor %}
  {% endwith %}
  <form action="{% url 'topic_photo' topic.id%}"
      enctype="multipart/form-data"
      method="POST">
  {% csrf_token %}
  <input type="file" name="photo_file">
  <input type="submit" class="btn" value="Upload Photo">   
  </form>
</div>
<div class="description-container">
  <p>{{ topic.description }}</p>
</div>

<div>
  <div class="form-container">
    <form action="{% url 'add_post' user.account.user_id topic.id %}" method="POST">
      {% csrf_token %}
      {{ post_form.as_p }}
      <input type="submit" class="btn" value="Add Post">
    </form>
  </div>
  <div class="page-content">
    {% for post in topic.post_set.all %}
      <a class="card-link" href="{% url 'post_detail' topic.id post.id %}">
        <div class="card">
            <div class=" card-content">
                <span class="card-title">{{ post.title }}</span>
                <p>{{ post.description }}</p>
                <p>{{ post.comment_set.count }}</p>
            </div>
            <div>
            {% with post.upvotes.all as upvotes  %}
                {% if user.account in upvotes %}
                <form action="{% url 'unupvote_post' topic.id post.id user.id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="btn">UnUpvote</button>
                    </form>
                {% else %}                    
                    <form action="{% url 'upvote_post' topic.id post.id user.id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="btn">Upvote</button>
                    </form>
                {% endif %}
            {% endwith %}
            </div>
            <span>{{ post.upvotes.count }}</span>
            <div>
                {% with post.downvotes.all as downvotes  %}
                    {% if user.account in downvotes %}
                    <form action="{% url 'undownvote_post' topic.id post.id user.id %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn">UnDownvote</button>
                        </form>
                    {% else %}                    
                        <form action="{% url 'downvote_post' topic.id post.id user.id %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn">Downvote</button>
                        </form>
                    {% endif %}
                {% endwith %}
            </div>
            <span>{{ post.downvotes.count }}</span>
            </div>
        </div>
      </a>
    {% endfor %}
  </div>
</div>
<div class="">
  {% with user.account.bookmarks.all as bookmarked_topics %}
      {% if topic in bookmarked_topics %}
      <form action="{% url 'unbookmark_topic' topic.id user.id %}" method="POST">
        {% csrf_token %}
        <button type="submit" class="btn">unBookmark</button>
      </form>
      {% else %}
      <form action="{% url 'bookmark_topic' topic.id user.id %}" method="POST">
        {% csrf_token %}
        <button type="submit" class="btn">Bookmark</button>
      </form>
      {% endif %}
  {% endwith %}
</div>
<div>

</div>

{% endblock %}